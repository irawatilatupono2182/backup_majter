<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Invoice - Adam Jaya</title>
    <link rel="stylesheet" href="../../assets/css/filament-style.css">
    <style>
        .tab-button {
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-600);
            transition: all 0.2s;
            margin-bottom: -2px;
        }
        .tab-button:hover {
            color: var(--primary-600);
            background: var(--gray-100);
        }
        .tab-button.active {
            color: var(--primary-600);
            border-bottom-color: var(--primary-600);
            background: white;
        }
        .type-selection-card {
            padding: 2rem 1.5rem;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .type-selection-card:hover {
            border-color: var(--primary-600);
            background: var(--primary-50);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        .items-section {
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
        .items-header {
            background: var(--gray-50);
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .item-row {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 80px;
            gap: 1rem;
            align-items: center;
        }
        .item-row:last-child {
            border-bottom: none;
        }
        .pdf-preview-btn {
            background: var(--danger-600);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .pdf-preview-btn:hover {
            background: var(--danger-700);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px -1px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body>
    <div class="filament-app">
        <aside class="filament-sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">üì¶</span>
                    <span class="logo-text">Adam Jaya</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-group">
                    <a href="../../index.html" class="nav-item">
                        <span class="nav-icon">üìä</span>
                        <span class="nav-label">Dashboard</span>
                    </a>
                </div>
                
                <div class="nav-group">
                    <div class="nav-group-label">üíº Penjualan</div>
                    <a href="customers.html" class="nav-item">
                        <span class="nav-icon">üë•</span>
                        <span class="nav-label">Customers</span>
                    </a>
                    <a href="price-quotations.html" class="nav-item">
                        <span class="nav-icon">üìã</span>
                        <span class="nav-label">Surat Penawaran</span>
                    </a>
                    <a href="delivery-notes.html" class="nav-item">
                        <span class="nav-icon">üöö</span>
                        <span class="nav-label">Surat Jalan</span>
                    </a>
                    <a href="invoices.html" class="nav-item active">
                        <span class="nav-icon">üí∞</span>
                        <span class="nav-label">Invoice</span>
                        <span class="nav-badge badge-danger">6</span>
                    </a>
                    <a href="nota-menyusuls.html" class="nav-item">
                        <span class="nav-icon">üìù</span>
                        <span class="nav-label">Nota Menyusul</span>
                    </a>
                    <a href="keterangan-lains.html" class="nav-item">
                        <span class="nav-icon">üìÑ</span>
                        <span class="nav-label">Keterangan Lain</span>
                    </a>
                </div>
                
                <div class="nav-group">
                    <div class="nav-group-label">üõí Pembelian</div>
                    <a href="stocks.html" class="nav-item">
                        <span class="nav-icon">üì¶</span>
                        <span class="nav-label">Master Barang/Stock</span>
                    </a>
                    <a href="suppliers.html" class="nav-item">
                        <span class="nav-icon">üè≠</span>
                        <span class="nav-label">Suppliers</span>
                    </a>
                    <a href="purchase-orders.html" class="nav-item">
                        <span class="nav-icon">üõçÔ∏è</span>
                        <span class="nav-label">Pembelian Barang (PO)</span>
                    </a>
                </div>
            </nav>
        </aside>

        <main class="filament-main">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle Sidebar">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                    </button>
                    <div class="breadcrumb">
                        <a href="../../index.html" class="breadcrumb-item">Dashboard</a>
                        <span class="breadcrumb-separator">/</span>
                        <span class="breadcrumb-item">Penjualan</span>
                        <span class="breadcrumb-separator">/</span>
                        <span class="breadcrumb-item">Invoice</span>
                    </div>
                </div>
                <div class="topbar-right">
                    <div class="user-menu">
                        <button class="user-avatar">SA</button>
                        <div class="user-dropdown">
                            <div class="user-info">
                                <div class="user-name">Super Admin</div>
                                <span class="badge badge-warning">Administrator</span>
                            </div>
                            <div class="user-menu-items">
                                <a href="#" class="user-menu-item">Profile</a>
                                <a href="#" class="user-menu-item">Settings</a>
                                <a href="#" class="user-menu-item">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="page-content">
                <!-- Stats -->
                <div class="stats-grid-4" style="margin-bottom: 1.5rem;">
                    <div class="stat-widget">
                        <div class="stat-header">
                            <span class="stat-label">Total Invoices</span>
                            <span class="stat-icon">üí∞</span>
                        </div>
                        <div class="stat-value" id="totalInvoices">0</div>
                        <div class="stat-footer">
                            <span class="stat-description">Invoice dibuat</span>
                        </div>
                    </div>
                    <div class="stat-widget success">
                        <div class="stat-header">
                            <span class="stat-label">Paid</span>
                            <span class="stat-icon">‚úÖ</span>
                        </div>
                        <div class="stat-value" id="paidInvoices">0</div>
                        <div class="stat-footer">
                            <span class="stat-description">Sudah dibayar</span>
                        </div>
                    </div>
                    <div class="stat-widget warning">
                        <div class="stat-header">
                            <span class="stat-label">Outstanding</span>
                            <span class="stat-icon">‚è≥</span>
                        </div>
                        <div class="stat-value" id="outstandingInvoices">0</div>
                        <div class="stat-footer">
                            <span class="stat-description">Belum dibayar</span>
                        </div>
                    </div>
                    <div class="stat-widget danger">
                        <div class="stat-header">
                            <span class="stat-label">Total Amount</span>
                            <span class="stat-icon">üí∏</span>
                        </div>
                        <div class="stat-value" id="totalAmount" style="font-size: 1rem;">Rp 0</div>
                        <div class="stat-footer">
                            <span class="stat-description">Total nilai invoice</span>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="widget-card">
                    <div class="card-header">
                        <h3 class="card-title">Daftar Invoice</h3>
                        <button class="btn-primary" onclick="showTypeSelectionModal()">
                            <span>‚ûï</span>
                            <span>Buat Invoice</span>
                        </button>
                    </div>

                    <!-- Tabs -->
                    <div style="padding: 1rem 1.25rem; border-bottom: 1px solid var(--gray-200); background: var(--gray-50);">
                        <div style="display: flex; gap: 0.5rem; border-bottom: 2px solid var(--gray-200);">
                            <button class="tab-button active" data-tab="all" onclick="switchTab('all')">
                                <span>üí∞</span>
                                <span>Semua Invoice</span>
                            </button>
                            <button class="tab-button" data-tab="PPN" onclick="switchTab('PPN')">
                                <span>üìò</span>
                                <span>PPN</span>
                            </button>
                            <button class="tab-button" data-tab="Non-PPN" onclick="switchTab('Non-PPN')">
                                <span>üìÑ</span>
                                <span>Non-PPN</span>
                            </button>
                        </div>
                    </div>

                    <div class="toolbar" style="padding: 1rem 1.25rem; border-bottom: 1px solid var(--gray-200);">
                        <div class="toolbar-left">
                            <div class="search-box">
                                <span class="search-icon">üîç</span>
                                <input type="text" class="search-input" placeholder="Cari nomor/customer..." id="searchInput">
                            </div>
                        </div>
                        <div class="toolbar-right">
                            <span id="filterInfo" style="color: var(--gray-600); font-size: 0.875rem;">Menampilkan: <strong>Semua Tipe</strong></span>
                        </div>
                    </div>

                    <div class="card-body no-padding">
                        <table class="filament-table">
                            <thead>
                                <tr>
                                    <th>No. Invoice</th>
                                    <th>Customer</th>
                                    <th>Tipe</th>
                                    <th>Tgl. Invoice</th>
                                    <th>Jatuh Tempo</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th class="text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTableBody"></tbody>
                        </table>
                    </div>

                    <div class="pagination" style="padding: 1rem 1.25rem;">
                        <div class="pagination-info">Menampilkan <strong id="displayCount">0</strong> dari <strong id="totalCount">0</strong> entri</div>
                        <div class="pagination-buttons">
                            <button class="pagination-button" disabled>‚Äπ Sebelumnya</button>
                            <button class="pagination-button active">1</button>
                            <button class="pagination-button" disabled>Selanjutnya ‚Ä∫</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="detailModal" style="display: none;">
        <div class="modal" style="max-width: 1200px;">
            <div class="modal-header">
                <h3 class="modal-title" id="detailModalTitle">Detail Invoice</h3>
                <button class="modal-close" onclick="closeDetailModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4 style="margin-bottom: 1rem;">Informasi Invoice</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">No. Invoice</label>
                                <input type="text" class="form-input" id="detailInvoiceNo" readonly style="background-color: var(--gray-100);">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tgl. Invoice</label>
                                <input type="text" class="form-input" id="detailInvoiceDate" readonly style="background-color: var(--gray-100);">
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Tgl. Jatuh Tempo</label>
                                <input type="text" class="form-input" id="detailDueDate" readonly style="background-color: var(--gray-100);">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tipe</label>
                                <input type="text" class="form-input" id="detailType" readonly style="background-color: var(--gray-100);">
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 1rem;">Informasi Customer</h4>
                        <div class="form-group">
                            <label class="form-label">Customer</label>
                            <input type="text" class="form-input" id="detailCustomer" readonly style="background-color: var(--gray-100);">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kontak Person</label>
                            <input type="text" class="form-input" id="detailContactPerson" readonly style="background-color: var(--gray-100);">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <span id="detailStatus" class="badge">Draft</span>
                        </div>
                    </div>
                </div>

                <div class="items-section">
                    <div class="items-header">
                        <h4>Items Invoice</h4>
                    </div>
                    <div id="detailItems"></div>
                </div>

                <div style="background: var(--gray-50); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 2rem; align-items: end;">
                        <div class="form-group">
                            <label class="form-label">Catatan</label>
                            <textarea class="form-textarea" id="detailNotes" readonly style="background-color: white; min-height: 80px;"></textarea>
                        </div>
                        <div style="text-align: right;">
                            <div style="margin-bottom: 0.5rem; color: var(--gray-600);">Subtotal: <strong id="detailSubtotal">Rp 0</strong></div>
                            <div style="margin-bottom: 0.5rem; color: var(--gray-600);" id="detailPpnRow">PPN 11%: <strong id="detailPpn">Rp 0</strong></div>
                            <div style="font-size: 1.25rem; font-weight: bold; color: var(--primary-600);">Total: <strong id="detailTotal">Rp 0</strong></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeDetailModal()">Tutup</button>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="pdf-preview-btn" onclick="previewInvoicePDFFromModal()" title="Lihat PDF">
                        <span>üìÑ</span>
                        <span>Lihat PDF</span>
                    </button>
                    <button class="pdf-preview-btn" onclick="downloadInvoicePDFFromModal()" title="Download PDF" style="background: var(--success-600);">
                        <span>üíæ</span>
                        <span>Download</span>
                    </button>
                    <button class="btn-primary" onclick="editFromDetail()">
                        <span>‚úèÔ∏è</span>
                        <span>Edit</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Type Selection Modal -->
    <div class="modal-overlay" id="typeSelectionModal" style="display: none;">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Pilih Tipe Invoice</h3>
                <button class="modal-close" onclick="closeTypeSelectionModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1.5rem; color: var(--gray-600);">Pilih tipe invoice yang akan Anda buat:</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <button class="type-selection-card" onclick="selectTypeAndCreate('PPN')">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üìò</div>
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">Invoice PPN</div>
                        <div style="font-size: 0.875rem; color: var(--gray-600);">Kena pajak</div>
                    </button>
                    <button class="type-selection-card" onclick="selectTypeAndCreate('Non-PPN')">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üìÑ</div>
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">Invoice Non-PPN</div>
                        <div style="font-size: 0.875rem; color: var(--gray-600);">Bebas pajak</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Modal -->
    <div class="modal-overlay" id="modalOverlay" style="display: none;">
        <div class="modal" style="max-width: 1200px;">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Buat Invoice</h3>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="invoiceForm">
                    <input type="hidden" id="invoiceId">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1.5rem;">
                        <div>
                            <h4 style="margin-bottom: 1rem;">Informasi Invoice</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label required">No. Invoice</label>
                                    <input type="text" class="form-input" id="invoiceNo" placeholder="INV-001" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label required">Tgl. Invoice</label>
                                    <input type="date" class="form-input" id="invoiceDate" required>
                                </div>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label required">Tgl. Jatuh Tempo</label>
                                    <input type="date" class="form-input" id="dueDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label required">Tipe</label>
                                    <select class="form-select" id="invoiceType" required disabled style="background-color: var(--gray-100);">
                                        <option value="">Pilih Tipe</option>
                                        <option value="PPN">PPN</option>
                                        <option value="Non-PPN">Non-PPN</option>
                                    </select>
                                    <p class="form-helper" id="typeHelper" style="margin-top: 0.5rem; color: var(--success-600); font-size: 0.875rem;"></p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 1rem;">Customer</h4>
                            <div class="form-group">
                                <label class="form-label required">Pilih Customer</label>
                                <select class="form-select" id="customerId" required>
                                    <option value="">Pilih Customer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Referensi</label>
                                <input type="text" class="form-input" id="reference" placeholder="PO Number, Quote Number, dll">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="status">
                                    <option value="draft">Draft</option>
                                    <option value="sent">Sent</option>
                                    <option value="paid">Paid</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="items-section">
                        <div class="items-header">
                            <h4>Items Invoice</h4>
                            <button type="button" class="btn-secondary btn-sm" onclick="addItem()">
                                <span>‚ûï</span>
                                <span>Tambah Item</span>
                            </button>
                        </div>
                        <div id="itemsContainer">
                            <div class="item-row">
                                <select class="form-select" name="product_id" onchange="updateItemPrice(this)">
                                    <option value="">Pilih Produk</option>
                                </select>
                                <input type="number" class="form-input" name="quantity" placeholder="Qty" min="1" value="1" onchange="calculateItemTotal(this)">
                                <input type="number" class="form-input" name="price" placeholder="Harga" min="0" step="0.01" onchange="calculateItemTotal(this)">
                                <input type="text" class="form-input" name="total" placeholder="Total" readonly style="background-color: var(--gray-100);">
                                <button type="button" class="btn-icon danger" onclick="removeItem(this)" title="Hapus">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>

                    <div style="background: var(--gray-50); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 2rem; align-items: end;">
                            <div class="form-group">
                                <label class="form-label">Catatan</label>
                                <textarea class="form-textarea" id="notes" rows="3" placeholder="Catatan untuk invoice..."></textarea>
                            </div>
                            <div style="text-align: right;">
                                <div style="margin-bottom: 0.5rem; color: var(--gray-600);">Subtotal: <strong id="subtotalValue">Rp 0</strong></div>
                                <div style="margin-bottom: 0.5rem; color: var(--gray-600);" id="ppnRow">PPN 11%: <strong id="ppnValue">Rp 0</strong></div>
                                <div style="font-size: 1.25rem; font-weight: bold; color: var(--primary-600);">Total: <strong id="totalValue">Rp 0</strong></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal()">Batal</button>
                <button class="btn-primary" onclick="saveInvoice()">
                    <span>üíæ</span>
                    <span>Simpan</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'all';
        let selectedType = null;
        let invoices = [
            { id: 1, invoice_no: 'INV-202402-001', customer: 'PT Maju Bersama', customer_id: 1, contact_person: 'Budi Santoso', type: 'PPN', invoice_date: '2024-02-15', due_date: '2024-03-16', reference: 'QUO-202402-001', status: 'sent', subtotal: 2500000, ppn: 275000, total: 2775000, notes: 'Invoice untuk pembelian bulanan', items: [{ product: 'Produk A', quantity: 25, price: 100000, total: 2500000 }] },
            { id: 2, invoice_no: 'INV-202402-002', customer: 'CV Berkah Jaya', customer_id: 2, contact_person: 'Siti Nurhaliza', type: 'Non-PPN', invoice_date: '2024-02-16', due_date: '2024-03-17', reference: 'SJ-202402-002', status: 'paid', subtotal: 1200000, ppn: 0, total: 1200000, notes: 'Invoice pembayaran cash', items: [{ product: 'Produk B', quantity: 8, price: 150000, total: 1200000 }] },
            { id: 3, invoice_no: 'INV-202402-003', customer: 'PT Global Mandiri', customer_id: 3, contact_person: 'Ahmad Rahman', type: 'PPN', invoice_date: '2024-01-17', due_date: '2024-02-10', reference: 'QUO-202402-003', status: 'overdue', subtotal: 3000000, ppn: 330000, total: 3330000, notes: 'Invoice untuk proyek khusus', items: [{ product: 'Produk C', quantity: 30, price: 100000, total: 3000000 }] },
            { id: 4, invoice_no: 'INV-202402-004', customer: 'Toko Sejahtera', customer_id: 4, contact_person: 'Dewi Sartika', type: 'Non-PPN', invoice_date: '2024-02-18', due_date: '2024-03-19', reference: '', status: 'draft', subtotal: 800000, ppn: 0, total: 800000, notes: 'Draft invoice', items: [{ product: 'Produk D', quantity: 4, price: 200000, total: 800000 }] },
            { id: 5, invoice_no: 'INV-202402-005', customer: 'PT Teknologi Maju', customer_id: 5, contact_person: 'Rizky Pratama', type: 'PPN', invoice_date: '2024-02-19', due_date: '2024-03-20', reference: 'QUO-202402-005', status: 'sent', subtotal: 1750000, ppn: 192500, total: 1942500, notes: 'Invoice rutin', items: [{ product: 'Produk E', quantity: 10, price: 175000, total: 1750000 }] },
            { id: 6, invoice_no: 'INV-202402-006', customer: 'PT Maju Bersama', customer_id: 1, contact_person: 'Budi Santoso', type: 'PPN', invoice_date: '2024-02-20', due_date: '2024-03-21', reference: 'SJ-202402-006', status: 'paid', subtotal: 1500000, ppn: 165000, total: 1665000, notes: 'Pembayaran selesai', items: [{ product: 'Produk A', quantity: 15, price: 100000, total: 1500000 }] }
        ];

        let customers = [
            { id: 1, name: 'PT Maju Bersama', contact_person: 'Budi Santoso', type: 'PPN', address_bill_to: 'Jl. Sudirman No. 123, Jakarta Pusat, DKI Jakarta 10220', address_ship_to: 'Jl. Sudirman No. 123, Jakarta Pusat, DKI Jakarta 10220' },
            { id: 2, name: 'CV Berkah Jaya', contact_person: 'Siti Nurhaliza', type: 'Non-PPN', address_bill_to: 'Jl. Kebon Jeruk No. 456, Jakarta Barat, DKI Jakarta 11530', address_ship_to: 'Jl. Kebon Jeruk No. 456, Jakarta Barat, DKI Jakarta 11530' },
            { id: 3, name: 'PT Global Mandiri', contact_person: 'Ahmad Rahman', type: 'PPN', address_bill_to: 'Jl. Gatot Subroto No. 789, Jakarta Selatan, DKI Jakarta 12930', address_ship_to: 'Jl. Gatot Subroto No. 789, Jakarta Selatan, DKI Jakarta 12930' },
            { id: 4, name: 'Toko Sejahtera', contact_person: 'Dewi Sartika', type: 'Non-PPN', address_bill_to: 'Jl. Thamrin No. 321, Jakarta Pusat, DKI Jakarta 10350', address_ship_to: 'Jl. Thamrin No. 321, Jakarta Pusat, DKI Jakarta 10350' },
            { id: 5, name: 'PT Teknologi Maju', contact_person: 'Rizky Pratama', type: 'PPN', address_bill_to: 'Jl. Kuningan No. 567, Jakarta Selatan, DKI Jakarta 12940', address_ship_to: 'Jl. Kuningan No. 567, Jakarta Selatan, DKI Jakarta 12940' }
        ];

        let products = [
            { id: 1, name: 'Produk A', price: 100000 },
            { id: 2, name: 'Produk B', price: 150000 },
            { id: 3, name: 'Produk C', price: 100000 },
            { id: 4, name: 'Produk D', price: 200000 },
            { id: 5, name: 'Produk E', price: 175000 }
        ];

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(amount);
        }

        function renderTable() {
            const tbody = document.getElementById('invoicesTableBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = invoices;
            if (currentTab !== 'all') {
                filtered = invoices.filter(inv => inv.type === currentTab);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(inv => 
                    inv.invoice_no.toLowerCase().includes(searchTerm) ||
                    inv.customer.toLowerCase().includes(searchTerm)
                );
            }
            
            document.getElementById('displayCount').textContent = filtered.length;
            document.getElementById('totalCount').textContent = invoices.length;
            
            tbody.innerHTML = filtered.map(invoice => `
                <tr>
                    <td><strong>${invoice.invoice_no}</strong></td>
                    <td>
                        <div style="font-weight: 500;">${invoice.customer}</div>
                        <div style="font-size: 0.875rem; color: var(--gray-600);">${invoice.contact_person}</div>
                    </td>
                    <td>
                        <span class="badge ${invoice.type === 'PPN' ? 'info' : 'gray'}">
                            ${invoice.type === 'PPN' ? 'üìò PPN' : 'üìÑ Non-PPN'}
                        </span>
                    </td>
                    <td>${new Date(invoice.invoice_date).toLocaleDateString('id-ID')}</td>
                    <td>
                        <div>${new Date(invoice.due_date).toLocaleDateString('id-ID')}</div>
                        ${invoice.status === 'overdue' ? '<div style="font-size: 0.75rem; color: var(--danger-600); font-weight: 500;">OVERDUE</div>' : ''}
                    </td>
                    <td><strong>${formatCurrency(invoice.total)}</strong></td>
                    <td>
                        <span class="badge ${
                            invoice.status === 'paid' ? 'success' : 
                            invoice.status === 'sent' ? 'info' : 
                            invoice.status === 'overdue' ? 'danger' : 'gray'
                        }">
                            ${invoice.status === 'paid' ? '‚úÖ Paid' : 
                              invoice.status === 'sent' ? 'üì§ Sent' : 
                              invoice.status === 'overdue' ? '‚ö†Ô∏è Overdue' : 'üìù Draft'}
                        </span>
                    </td>
                    <td class="text-right">
                        <div class="table-actions" style="justify-content: flex-end;">
                            <button class="btn-icon" onclick="viewInvoice(${invoice.id})" title="View">üëÅÔ∏è</button>
                            <button class="pdf-preview-btn" onclick="previewInvoicePDF(${invoice.id})" title="Preview PDF" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">üìÑ</button>
                            <button class="btn-icon" onclick="editInvoice(${invoice.id})" title="Edit">‚úèÔ∏è</button>
                            <button class="btn-icon danger" onclick="deleteInvoice(${invoice.id})" title="Delete">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalInvoices').textContent = invoices.length;
            document.getElementById('paidInvoices').textContent = invoices.filter(inv => inv.status === 'paid').length;
            document.getElementById('outstandingInvoices').textContent = invoices.filter(inv => inv.status !== 'paid').length;
            
            const totalAmount = invoices.reduce((sum, inv) => sum + inv.total, 0);
            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tab) btn.classList.add('active');
            });
            
            const filterInfo = document.getElementById('filterInfo');
            if (tab === 'all') filterInfo.innerHTML = 'Menampilkan: <strong>Semua Tipe</strong>';
            else if (tab === 'PPN') filterInfo.innerHTML = 'Menampilkan: <strong>üìò PPN</strong>';
            else if (tab === 'Non-PPN') filterInfo.innerHTML = 'Menampilkan: <strong>üìÑ Non-PPN</strong>';
            
            renderTable();
        }

        function showTypeSelectionModal() {
            document.getElementById('typeSelectionModal').style.display = 'flex';
            setTimeout(() => document.getElementById('typeSelectionModal').classList.add('show'), 10);
        }

        function closeTypeSelectionModal() {
            document.getElementById('typeSelectionModal').classList.remove('show');
            setTimeout(() => document.getElementById('typeSelectionModal').style.display = 'none', 200);
        }

        function selectTypeAndCreate(type) {
            selectedType = type;
            closeTypeSelectionModal();
            setTimeout(() => showCreateModal(), 300);
        }

        function showCreateModal() {
            document.getElementById('modalTitle').textContent = 'Buat Invoice';
            document.getElementById('invoiceForm').reset();
            document.getElementById('invoiceId').value = '';
            document.getElementById('status').value = 'draft';
            
            const today = new Date();
            document.getElementById('invoiceDate').value = today.toISOString().split('T')[0];
            
            const dueDate = new Date(today);
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
            
            if (selectedType) {
                document.getElementById('invoiceType').value = selectedType;
                document.getElementById('invoiceType').disabled = true;
                
                const helper = document.getElementById('typeHelper');
                if (selectedType === 'PPN') {
                    helper.innerHTML = 'üìò Invoice PPN dipilih';
                    helper.style.color = 'var(--primary-600)';
                } else {
                    helper.innerHTML = 'üìÑ Invoice Non-PPN dipilih';
                    helper.style.color = 'var(--success-600)';
                }
            }
            
            populateCustomers();
            populateProducts();
            calculateTotals();
            
            document.getElementById('modalOverlay').style.display = 'flex';
            setTimeout(() => document.getElementById('modalOverlay').classList.add('show'), 10);
        }

        function populateCustomers() {
            const select = document.getElementById('customerId');
            select.innerHTML = '<option value="">Pilih Customer</option>';
            customers.forEach(customer => {
                select.innerHTML += `<option value="${customer.id}">${customer.name} - ${customer.contact_person}</option>`;
            });
        }

        function populateProducts() {
            const selects = document.querySelectorAll('select[name="product_id"]');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Pilih Produk</option>';
                products.forEach(product => {
                    select.innerHTML += `<option value="${product.id}" data-price="${product.price}">${product.name} - ${formatCurrency(product.price)}</option>`;
                });
            });
        }

        function addItem() {
            const container = document.getElementById('itemsContainer');
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.innerHTML = `
                <select class="form-select" name="product_id" onchange="updateItemPrice(this)">
                    <option value="">Pilih Produk</option>
                </select>
                <input type="number" class="form-input" name="quantity" placeholder="Qty" min="1" value="1" onchange="calculateItemTotal(this)">
                <input type="number" class="form-input" name="price" placeholder="Harga" min="0" step="0.01" onchange="calculateItemTotal(this)">
                <input type="text" class="form-input" name="total" placeholder="Total" readonly style="background-color: var(--gray-100);">
                <button type="button" class="btn-icon danger" onclick="removeItem(this)" title="Hapus">üóëÔ∏è</button>
            `;
            container.appendChild(itemRow);
            
            const select = itemRow.querySelector('select[name="product_id"]');
            select.innerHTML = '<option value="">Pilih Produk</option>';
            products.forEach(product => {
                select.innerHTML += `<option value="${product.id}" data-price="${product.price}">${product.name} - ${formatCurrency(product.price)}</option>`;
            });
        }

        function removeItem(button) {
            button.parentElement.remove();
            calculateTotals();
        }

        function updateItemPrice(select) {
            const option = select.selectedOptions[0];
            const price = option ? option.getAttribute('data-price') : 0;
            const priceInput = select.parentElement.querySelector('input[name="price"]');
            priceInput.value = price;
            calculateItemTotal(priceInput);
        }

        function calculateItemTotal(input) {
            const row = input.parentElement;
            const quantity = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;
            const price = parseFloat(row.querySelector('input[name="price"]').value) || 0;
            const total = quantity * price;
            row.querySelector('input[name="total"]').value = formatCurrency(total);
            calculateTotals();
        }

        function calculateTotals() {
            const rows = document.querySelectorAll('#itemsContainer .item-row');
            let subtotal = 0;
            
            rows.forEach(row => {
                const quantity = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;
                const price = parseFloat(row.querySelector('input[name="price"]').value) || 0;
                subtotal += quantity * price;
            });
            
            const type = document.getElementById('invoiceType').value;
            const ppn = type === 'PPN' ? subtotal * 0.11 : 0;
            const total = subtotal + ppn;
            
            document.getElementById('subtotalValue').textContent = formatCurrency(subtotal);
            document.getElementById('ppnValue').textContent = formatCurrency(ppn);
            document.getElementById('totalValue').textContent = formatCurrency(total);
            
            const ppnRow = document.getElementById('ppnRow');
            ppnRow.style.display = type === 'PPN' ? 'block' : 'none';
        }

        function viewInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            document.getElementById('detailModalTitle').textContent = `Detail - ${invoice.invoice_no}`;
            document.getElementById('detailInvoiceNo').value = invoice.invoice_no;
            document.getElementById('detailInvoiceDate').value = new Date(invoice.invoice_date).toLocaleDateString('id-ID');
            document.getElementById('detailDueDate').value = new Date(invoice.due_date).toLocaleDateString('id-ID');
            document.getElementById('detailType').value = invoice.type === 'PPN' ? 'üìò PPN' : 'üìÑ Non-PPN';
            document.getElementById('detailCustomer').value = invoice.customer;
            document.getElementById('detailContactPerson').value = invoice.contact_person;
            document.getElementById('detailNotes').value = invoice.notes || '';
            
            const statusElement = document.getElementById('detailStatus');
            statusElement.className = `badge ${
                invoice.status === 'paid' ? 'success' : 
                invoice.status === 'sent' ? 'info' : 
                invoice.status === 'overdue' ? 'danger' : 'gray'
            }`;
            statusElement.innerHTML = invoice.status === 'paid' ? '‚úÖ Paid' : 
                                    invoice.status === 'sent' ? 'üì§ Sent' : 
                                    invoice.status === 'overdue' ? '‚ö†Ô∏è Overdue' : 'üìù Draft';
            
            // Populate items
            const itemsContainer = document.getElementById('detailItems');
            itemsContainer.innerHTML = invoice.items.map(item => `
                <div class="item-row">
                    <div style="font-weight: 500;">${item.product}</div>
                    <div style="text-align: center;">${item.quantity}</div>
                    <div style="text-align: right;">${formatCurrency(item.price)}</div>
                    <div style="text-align: right; font-weight: 500;">${formatCurrency(item.total)}</div>
                    <div></div>
                </div>
            `).join('');
            
            document.getElementById('detailSubtotal').textContent = formatCurrency(invoice.subtotal);
            document.getElementById('detailPpn').textContent = formatCurrency(invoice.ppn);
            document.getElementById('detailTotal').textContent = formatCurrency(invoice.total);
            
            const detailPpnRow = document.getElementById('detailPpnRow');
            detailPpnRow.style.display = invoice.type === 'PPN' ? 'block' : 'none';
            
            document.getElementById('detailModal').dataset.invoiceId = invoice.id;
            document.getElementById('detailModal').style.display = 'flex';
            setTimeout(() => document.getElementById('detailModal').classList.add('show'), 10);
        }

        function previewInvoicePDF(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) {
                alert('Data invoice tidak ditemukan!');
                return;
            }

            const content = generateInvoicePDFContent(id);
            if (!content) {
                alert('Gagal membuat PDF!');
                return;
            }

            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <html>
                <head>
                    <title>Preview - ${invoice.invoice_no}</title>
                    <style>
                        body { margin: 0; padding: 20px; background: #f5f5f5; }
                        @media print { 
                            body { background: white; } 
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="no-print" style="text-align: center; margin-bottom: 20px;">
                        <button onclick="window.print()" style="background: #059669; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">üñ®Ô∏è Print</button>
                        <button onclick="window.close()" style="background: #dc2626; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">‚ùå Tutup</button>
                    </div>
                    ${content}
                </body>
                </html>
            `);
            previewWindow.document.close();
        }

        function editInvoice(id) {
            alert('Fitur edit akan diimplementasikan');
        }

        function deleteInvoice(id) {
            if (confirm('Apakah Anda yakin ingin menghapus invoice ini?')) {
                const index = invoices.findIndex(inv => inv.id === id);
                if (index !== -1) {
                    invoices.splice(index, 1);
                    renderTable();
                    updateStats();
                    alert('Invoice berhasil dihapus!');
                }
            }
        }

        function closeModal() {
            selectedType = null;
            document.getElementById('modalOverlay').classList.remove('show');
            setTimeout(() => document.getElementById('modalOverlay').style.display = 'none', 200);
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('show');
            setTimeout(() => document.getElementById('detailModal').style.display = 'none', 200);
        }

        function editFromDetail() {
            const invoiceId = document.getElementById('detailModal').dataset.invoiceId;
            closeDetailModal();
            setTimeout(() => editInvoice(parseInt(invoiceId)), 300);
        }

        function saveInvoice() {
            const invoice_no = document.getElementById('invoiceNo').value;
            const customer_id = document.getElementById('customerId').value;
            const type = document.getElementById('invoiceType').value;
            const invoice_date = document.getElementById('invoiceDate').value;
            const due_date = document.getElementById('dueDate').value;

            if (!invoice_no || !customer_id || !type || !invoice_date || !due_date) {
                alert('Data wajib harus diisi!');
                return;
            }

            const customer = customers.find(c => c.id === parseInt(customer_id));
            
            // Collect items
            const itemRows = document.querySelectorAll('#itemsContainer .item-row');
            const items = Array.from(itemRows).map(row => {
                const productSelect = row.querySelector('select[name="product_id"]');
                const quantity = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;
                const price = parseFloat(row.querySelector('input[name="price"]').value) || 0;
                const product = products.find(p => p.id === parseInt(productSelect.value));
                
                return {
                    product: product ? product.name : '',
                    quantity,
                    price,
                    total: quantity * price
                };
            }).filter(item => item.product && item.quantity > 0);
            
            if (items.length === 0) {
                alert('Minimal harus ada 1 item!');
                return;
            }
            
            const subtotal = items.reduce((sum, item) => sum + item.total, 0);
            const ppn = type === 'PPN' ? subtotal * 0.11 : 0;
            const total = subtotal + ppn;

            const invoiceData = {
                invoice_no,
                customer: customer.name,
                customer_id: parseInt(customer_id),
                contact_person: customer.contact_person,
                type,
                invoice_date,
                due_date,
                reference: document.getElementById('reference').value,
                status: document.getElementById('status').value,
                subtotal,
                ppn,
                total,
                notes: document.getElementById('notes').value,
                items
            };

            const id = document.getElementById('invoiceId').value;
            if (id) {
                const invoice = invoices.find(inv => inv.id === parseInt(id));
                if (invoice) {
                    Object.assign(invoice, invoiceData);
                }
                alert('Invoice berhasil diupdate!');
            } else {
                invoiceData.id = Math.max(...invoices.map(inv => inv.id), 0) + 1;
                invoices.push(invoiceData);
                alert('Invoice berhasil dibuat!');
            }

            closeModal();
            renderTable();
            updateStats();
        }

        document.getElementById('searchInput').addEventListener('input', renderTable);
        
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            renderTable();
        });

        // PDF Generation Functions for Invoice
        function generateInvoicePDFContent(invoiceId) {
            const invoice = invoices.find(inv => inv.id === parseInt(invoiceId));
            if (!invoice) return '';

            const currentDate = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase();
            const invoiceDate = new Date(invoice.invoice_date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase();
            const dueDate = new Date(invoice.due_date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase();
            
            const isPPN = invoice.type === 'PPN';
            
            // Get customer info
            const customer = customers.find(c => c.id === invoice.customer_id);
            
            // Generate different HTML based on PPN/Non-PPN
            if (isPPN) {
                // PPN Template - Standard Layout (Logo Left + Company Center + Title Right)
                return `
                    <!DOCTYPE html>
                    <html lang="id">
                    <head>
                        <meta charset="utf-8">
                        <title>Invoice - ${invoice.invoice_no}</title>
                        <style>
                            @page { margin: 0; size: A4 portrait; }
                            * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
                            body { background: white; margin: 0; padding: 0.6cm 1cm; }
                            .container { width: 100%; max-width: 21cm; margin: 0 auto; padding: 0; }
                            table { border-collapse: collapse; }
                            .header-table { width: 100%; border-bottom: 2px solid #000; padding: 8px 10px 12px 10px; margin-bottom: 10px; }
                            .logo-box { width: 84px; height: 84px; border: 0px solid #000; display: inline-block; text-align: center; vertical-align: middle; padding: 4px; }
                            .company-info { font-size: 13px; line-height: 1.4; font-weight: normal; }
                            .company-info strong { font-size: 28px; font-weight: 900; }
                            .invoice-title { font-size: 39px; font-weight: 900; letter-spacing: 8px; line-height: 1; margin: 0; }
                            .items-table { width: 100%; margin: 8px 0; font-size: 13px; border: none; }
                            .items-table th { border-top: 2px solid #000; border-bottom: 2px solid #000; border-left: 1.5px solid #000; border-right: 1.5px solid #000; padding: 8px 6px; text-align: center; font-weight: bold; font-size: 14px; background-color: #fff; }
                            .items-table td { border-left: 1.5px solid #000; border-right: 1.5px solid #000; border-bottom: 1px solid #ddd; padding: 8px 6px; text-align: left; vertical-align: top; font-size: 13px; }
                            .items-table tbody tr:last-child td { border-bottom: 2px solid #000; }
                            .items-table .col-no { width: 35px; text-align: center; }
                            .items-table .col-desc { width: auto; padding-left: 6px; }
                            .items-table .col-qty { width: 70px; text-align: center; }
                            .items-table .col-price { width: 100px; text-align: right; padding-right: 6px; }
                            .items-table .col-amount { width: 100px; text-align: right; padding-right: 6px; }
                            .bank-box { border: 1.5px solid #000; padding: 8px; width: 48%; float: left; margin-right: 4%; font-size: 13px; }
                            .signature-box { width: 48%; float: right; text-align: center; padding: 8px; font-size: 13px; }
                            .signature-space { height: 50px; margin: 10px 0; }
                            .clearfix::after { content: ""; display: table; clear: both; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <table class="header-table">
                                <tr>
                                    <td style="width: 50%; vertical-align: top;">
                                        <table style="width: 100%;">
                                            <tr>
                                                <td style="width: 94px; vertical-align: top;">
                                                    <div class="logo-box"><div style="width: 84px; height: 84px; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #6b7280; border-radius: 4px;">AJ LOGO</div></div>
                                                </td>
                                                <td style="vertical-align: top; padding-left: 10px;">
                                                    <div class="company-info"><strong>CV. ADAM JAYA</strong><br>Jl. Sadang, Rahayu, Kab. Bandung<br>Jawa Barat 40218<br>Telp: 085721322812 | Email: majter.ads@gmail.com</div>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                    <td style="width: 50%; vertical-align: middle; text-align: right; padding-right: 0;">
                                        <div class="invoice-title">INVOICE</div>
                                    </td>
                                </tr>
                                <tr><td colspan="2" style="height: 8px;"></td></tr>
                            </table>

                            <div style="padding: 10px 12px; margin-bottom: 10px;">
                                <table style="width: 100%; margin-bottom: 8px;">
                                    <tr>
                                        <td style="width: 55%; vertical-align: top; padding-right: 10px;">
                                            <div style="font-size: 14px; line-height: 1.5; margin-bottom: 6px;"><strong>BILL TO : ${invoice.customer.toUpperCase()}</strong></div>
                                            <div style="font-size: 13px; line-height: 1.4; margin-top: 4px;">${customer ? customer.address_bill_to : '-'}</div>
                                        </td>
                                        <td style="width: 45%; vertical-align: top; padding-left: 10px;">
                                            <div style="text-align: right;">
                                                <table style="font-size: 13px; margin-bottom: 6px; margin-left: auto;">
                                                    <tr><td colspan="2" style="padding: 2px 0; padding-bottom: 6px; text-align: right;"><strong>BANDUNG, ${invoiceDate}</strong></td></tr>
                                                    <tr><td style="width: 90px; padding: 2px 0; text-align: left;">NO INVOICE</td><td style="padding: 2px 0; text-align: left;">: ${invoice.invoice_no}</td></tr>
                                                    ${invoice.reference ? `<tr><td style="padding: 2px 0; text-align: left;">PO NO.</td><td style="padding: 2px 0; text-align: left;">: ${invoice.reference}</td></tr>` : ''}
                                                    <tr><td style="padding: 2px 0; text-align: left;">TOP</td><td style="padding: 2px 0; text-align: left;">: 30 HARI</td></tr>
                                                </table>
                                            </div>
                                        </td>
                                    </tr>
                                </table>

                                <table class="items-table">
                                    <thead>
                                        <tr>
                                            <th class="col-no">NO</th>
                                            <th class="col-desc">DESCRIPTION</th>
                                            <th class="col-qty">QTY</th>
                                            <th class="col-price">HARGA SATUAN (Rp.)</th>
                                            <th class="col-amount">AMOUNT (Rp.)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${invoice.items.map((item, index) => `
                                            <tr>
                                                <td class="col-no">${index + 1}.</td>
                                                <td class="col-desc">${item.product.toUpperCase()}</td>
                                                <td class="col-qty">${item.quantity.toLocaleString('id-ID')} PCS</td>
                                                <td class="col-price">Rp. ${item.price.toLocaleString('id-ID')}</td>
                                                <td class="col-amount">Rp. ${item.total.toLocaleString('id-ID')}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>

                                <div style="text-align: right; padding-right: 0; margin-top: 8px;">
                                    <table style="font-size: 13px; margin-left: auto; display: inline-table;">
                                        <tr><td style="padding: 2px 10px 2px 0; width: 150px; text-align: left;">SUB. TOTAL</td><td style="padding: 2px 0; text-align: left;">: Rp. ${invoice.subtotal.toLocaleString('id-ID')}</td></tr>
                                        <tr><td style="padding: 2px 10px 2px 0; text-align: left;">DPP NILAI LAIN</td><td style="padding: 2px 0; text-align: left;">: Rp. 0</td></tr>
                                        <tr><td style="padding: 2px 10px 2px 0; text-align: left;"><strong>PPN</strong></td><td style="padding: 2px 0; text-align: left;">: Rp. ${invoice.ppn.toLocaleString('id-ID')}</td></tr>
                                        <tr><td style="padding: 2px 10px 2px 0; border-bottom: 2px solid #000; text-align: left;"><strong>GRAND TOTAL</strong></td><td style="padding: 2px 0; border-bottom: 2px solid #000; text-align: left;">: <strong>Rp. ${invoice.total.toLocaleString('id-ID')}</strong></td></tr>
                                    </table>
                                </div>

                                <div class="clearfix" style="margin-top: 5px; margin-bottom: 10px;">
                                    <div class="bank-box"><strong>PEMBAYARAN HARAP DI TRANSFER KE :</strong><br><div style="margin-top: 6px;"><table style="width: 100%; font-size: 11px;"><tr><td style="width: 60px; vertical-align: top;">BCA</td><td style="vertical-align: top;">- 156 156 2275 A/N <strong>ADAM JAYA CV</strong></td></tr></table></div></div>
                                    <div class="signature-box">
                                        <div>HORMAT KAMI</div>
                                        <div class="signature-space"></div>
                                    </div>
                                </div>

                                ${invoice.notes ? `<div style="clear: both; margin-top: 20px; padding: 8px; border: 1px solid #000; font-size: 12px;"><strong>Catatan:</strong> ${invoice.notes}</div>` : ''}
                            </div>
                        </div>
                    </body>
                    </html>
                `;
            } else {
                // Non-PPN Template - Alternative Layout (Title Left + Logo+Branding Right)
                return `
                    <!DOCTYPE html>
                    <html lang="id">
                    <head>
                        <meta charset="utf-8">
                        <title>Invoice - ${invoice.invoice_no}</title>
                        <style>
                            @page { margin: 0; size: A4 portrait; }
                            * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
                            body { background: white; margin: 0; padding: 0.6cm 1cm; }
                            .container { width: 100%; max-width: 21cm; margin: 0 auto; padding: 0; }
                            table { border-collapse: collapse; }
                            .header-table { width: 100%; border-bottom: 2px solid #000; padding: 8px 0px 12px 0px; margin-bottom: 10px; }
                            .logo-box { width: 112px; height: 49px; border: 0px solid #000; display: inline-block; text-align: center; vertical-align: middle; margin-right: 8px; margin-bottom: 4px; padding: 3px; }
                            .invoice-title { text-align: left; font-size: 28px; font-weight: 900; letter-spacing: 7px; line-height: 1; margin: 0; }
                            .company-logo-section { text-align: left; font-size: 14px; line-height: 1.3; display: inline-block; vertical-align: middle; }
                            .company-brand { font-size: 20px; font-weight: 900; letter-spacing: 3px; }
                            .company-tagline { font-size: 11px; margin-top: 2px; }
                            .items-table { width: 100%; margin: 8px 0; font-size: 13px; border: 2px solid #000; }
                            .items-table th { border-top: none; border-bottom: 2px solid #000; border-left: 1.5px solid #000; border-right: 1.5px solid #000; padding: 8px 6px; text-align: center; font-weight: bold; font-size: 14px; background-color: #fff; }
                            .items-table td { border-left: 1.5px solid #000; border-right: 1.5px solid #000; border-bottom: 1px solid #ddd; padding: 8px 6px; text-align: left; vertical-align: top; font-size: 13px; }
                            .items-table tbody tr:last-child td { border-bottom: none; }
                            .items-table .col-no { width: 35px; text-align: center; }
                            .items-table .col-desc { width: auto; padding-left: 6px; }
                            .items-table .col-qty { width: 70px; text-align: center; }
                            .items-table .col-price { width: 100px; text-align: right; padding-right: 6px; }
                            .items-table .col-amount { width: 100px; text-align: right; padding-right: 6px; }
                            .bank-box { border: 1.5px solid #000; padding: 8px; width: 48%; float: left; margin-right: 4%; font-size: 13px; }
                            .signature-box { width: 48%; float: right; text-align: center; padding: 8px; font-size: 13px; }
                            .signature-space { height: 50px; margin: 10px 0; }
                            .clearfix::after { content: ""; display: table; clear: both; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <table class="header-table">
                                <tr>
                                    <td style="width: 50%; vertical-align: middle; padding-left: 0;">
                                        <div class="invoice-title">INVOICE</div>
                                    </td>
                                    <td style="width: 50%; vertical-align: middle; text-align: right; padding-right: 0;">
                                        <div style="display: inline-block; text-align: right;">
                                            <div class="logo-box" style="display: inline-block; vertical-align: middle; margin-right: 8px;"><div style="width: 112px; height: 49px; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #6b7280; border-radius: 4px;">MAJTER LOGO</div></div>
                                            <span style="display: inline-block; vertical-align: middle; font-size: 20px; font-weight: 300; margin: 0 8px; color: #000;">|</span>
                                            <div class="company-logo-section" style="display: inline-block; vertical-align: middle; margin-left: 8px;">
                                                <div class="company-brand">AJT</div>
                                                <div class="company-tagline">BANDUNG - JAWA BARAT 40218</div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </table>

                            <div style="padding: 10px 12px; margin-bottom: 10px;">
                                <table style="width: 100%; margin-bottom: 8px;">
                                    <tr>
                                        <td style="width: 55%; vertical-align: top; padding-right: 10px;">
                                            <div style="font-size: 14px; line-height: 1.5; margin-bottom: 6px;"><strong>BILL TO : ${invoice.customer.toUpperCase()}</strong></div>
                                            <div style="font-size: 13px; line-height: 1.4; margin-top: 4px;">${customer ? customer.address_bill_to : '-'}</div>
                                        </td>
                                        <td style="width: 45%; vertical-align: top; padding-left: 10px;">
                                            <div style="text-align: right;">
                                                <table style="font-size: 13px; margin-bottom: 6px; margin-left: auto;">
                                                    <tr><td colspan="2" style="padding: 2px 0; padding-bottom: 6px; text-align: right;"><strong>BANDUNG, ${invoiceDate}</strong></td></tr>
                                                    <tr><td style="width: 90px; padding: 2px 0; text-align: left;">NO INVOICE</td><td style="padding: 2px 0; text-align: left;">: ${invoice.invoice_no}</td></tr>
                                                    ${invoice.reference ? `<tr><td style="padding: 2px 0; text-align: left;">PO NO.</td><td style="padding: 2px 0; text-align: left;">: ${invoice.reference}</td></tr>` : ''}
                                                    <tr><td style="padding: 2px 0; text-align: left;">TOP</td><td style="padding: 2px 0; text-align: left;">: 30 HARI</td></tr>
                                                </table>
                                            </div>
                                        </td>
                                    </tr>
                                </table>

                                <table class="items-table">
                                    <thead>
                                        <tr>
                                            <th class="col-no">NO</th>
                                            <th class="col-desc">DESCRIPTION</th>
                                            <th class="col-qty">QTY</th>
                                            <th class="col-price">HARGA SATUAN (Rp.)</th>
                                            <th class="col-amount">AMOUNT (Rp.)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${invoice.items.map((item, index) => `
                                            <tr>
                                                <td class="col-no">${index + 1}.</td>
                                                <td class="col-desc">${item.product.toUpperCase()}</td>
                                                <td class="col-qty">${item.quantity.toLocaleString('id-ID')} PCS</td>
                                                <td class="col-price">Rp. ${item.price.toLocaleString('id-ID')}</td>
                                                <td class="col-amount">Rp. ${item.total.toLocaleString('id-ID')}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>

                                <div style="text-align: right; padding-right: 0; margin-top: 8px;">
                                    <table style="font-size: 13px; margin-left: auto; display: inline-table;">
                                        <tr><td style="padding: 2px 10px 2px 0; width: 150px; text-align: left;">SUB. TOTAL</td><td style="padding: 2px 0; text-align: left;">: Rp. ${invoice.subtotal.toLocaleString('id-ID')}</td></tr>
                                        <tr><td style="padding: 2px 10px 2px 0; text-align: left;">DPP NILAI LAIN</td><td style="padding: 2px 0; text-align: left;">: Rp. 0</td></tr>
                                        <tr><td style="padding: 2px 10px 2px 0; border-bottom: 2px solid #000; text-align: left;"><strong>GRAND TOTAL</strong></td><td style="padding: 2px 0; border-bottom: 2px solid #000; text-align: left;">: <strong>Rp. ${invoice.total.toLocaleString('id-ID')}</strong></td></tr>
                                    </table>
                                </div>

                                <div class="clearfix" style="margin-top: 5px; margin-bottom: 10px;">
                                    <div class="bank-box"><strong>PEMBAYARAN HARAP DI TRANSFER KE :</strong><br><div style="margin-top: 6px;"><table style="width: 100%; font-size: 11px;"><tr><td style="width: 60px; vertical-align: top;">BCA</td><td style="vertical-align: top;">- 139 0800 645 A/N <strong>DIO GIANI PUTRA</strong></td></tr></table></div></div>
                                    <div class="signature-box">
                                        <div>HORMAT KAMI</div>
                                        <div class="signature-space"></div>
                                    </div>
                                </div>

                                ${invoice.notes ? `<div style="clear: both; margin-top: 20px; padding: 8px; border: 1px solid #000; font-size: 12px;"><strong>Catatan:</strong> ${invoice.notes}</div>` : ''}
                            </div>
                        </div>
                    </body>
                    </html>
                `;
            }
        }

        function previewInvoicePDFFromModal() {
            const invoiceId = document.getElementById('detailModal').dataset.invoiceId;
            if (invoiceId) {
                previewInvoicePDF(parseInt(invoiceId));
            }
        }

        function downloadInvoicePDFFromModal() {
            const invoiceId = document.getElementById('detailModal').dataset.invoiceId;
            if (invoiceId) {
                downloadInvoicePDF(parseInt(invoiceId));
            }
        }

        function downloadInvoicePDF(id) {
            const invoice = invoices.find(inv => inv.id === parseInt(id));
            if (!invoice) {
                alert('Data invoice tidak ditemukan!');
                return;
            }

            const content = generateInvoicePDFContent(id);
            if (!content) {
                alert('Gagal membuat PDF!');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Invoice - ${invoice.invoice_no}</title>
                    <style>
                        body { margin: 0; padding: 15px; }
                        @page { margin: 1cm; }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `);
            printWindow.document.close();
            
            // Auto print and suggest save as PDF
            setTimeout(() => {
                printWindow.print();
                alert('Silakan pilih "Simpan sebagai PDF" atau "Microsoft Print to PDF" pada dialog print untuk menyimpan file PDF.');
            }, 500);
        }
        
        // Event listeners for closing modals
        document.getElementById('typeSelectionModal').addEventListener('click', function(e) {
            if (e.target === this) closeTypeSelectionModal();
        });
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) closeDetailModal();
        });
        
        // Update calculate totals when invoice type changes
        document.getElementById('invoiceType').addEventListener('change', calculateTotals);
    </script>
    <script src="../../assets/js/filament-dashboard.js"></script>
</body>
</html>